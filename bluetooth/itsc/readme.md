- [Introcution](#introcution)
- [Data structure](#data-structure)
  - [`division_id`](#division_id)
    - [8026: TPANA Bluetooth](#8026-tpana-bluetooth)
    - [2: RESCU (Stinson)](#2-rescu-stinson)
    - [8046: Miovision](#8046-miovision)
    - [`bluetooth.itsc_tt_paths` (table)](#bluetoothitsc_tt_paths-table)
  - [`itsc_tt_raw` vs `itsc_tt_raw_pathdata`](#itsc_tt_raw-vs-itsc_tt_raw_pathdata)
    - [`bluetooth.itsc_tt_raw` (partitioned table)](#bluetoothitsc_tt_raw-partitioned-table)
    - [`bluetooth.itsc_tt_raw_pathdata` (partitioned table)](#bluetoothitsc_tt_raw_pathdata-partitioned-table)
- [Analysis](#analysis)
- [Data Ops](#data-ops)
  - [`bluetooth_itsc_pull` DAG](#bluetooth_itsc_pull-dag)
  - [Path Geoms](#path-geoms)

# Introcution
This folder contains Bluetooth travel time data pulled from ITS Central, including data from TPANA, Stinson and Miovision networks.

# Data structure

## `division_id`
Travel time sensors are organized roughly by vendor into `division_id`s. Below are screenshots of the paths from `bluetooth.itsc_tt_paths`, filtering for each `division_id`.

### [8026: TPANA Bluetooth](https://itscentral.corp.toronto.ca/TravelTime?divisionIds=8026)
<p align="left">
    <img src="img/{4C0934FE-C5DC-4000-A0B7-9B2852CE30B0}.png" alt="division_id = 8026" width="50%"/>
</p>

### [2: RESCU (Stinson)](https://itscentral.corp.toronto.ca/TravelTime?divisionIds=2)
Data for division_id = 2 is only in `itsc_tt_raw`.
<p align="left">
    <img src="img/{6D98ED03-F84A-4DEB-B3AF-9C0366283A62}.png" alt="division_id = 2" width="50%"/>
</p>

### [8046: Miovision](https://itscentral.corp.toronto.ca/TravelTime?divisionIds=8046)
- We have access to this data as well through the Miovision API, where we may be able to configure new paths.
- Note `travel_time_s` for Miovision represents median travel time. 

<p align="left">
    <img src="img/{DA63E27E-6348-4A7C-9C5C-49C5B1D35D6C}.png" alt="division_id = 8046" width="50%"/>
</p>


### `bluetooth.itsc_tt_paths` (table)
Approx row count:                  800

Contains path metadata for ITSC bluetooth tables.

| Column Name                                  | Data Type                   | Sample                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Comments   |
|----------------------------------------------|-----------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------|
| division_id                                  | smallint                    | 8046                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 2: RESCU (Stinson), 8046: miovision, 8026: TPANA Bluetooth |
| path_id                                      | integer                     | 10528030                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |            |
| source_id                                    | character varying(1000)     | TT_d8ca3237-49d1-4543-85b5-9c2ea61c4239_e92f628e-fa46-49c6-88c7-f8c715d243de                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |            |
| algorithm                                    | integer                     | 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |            |
| first_feature_start_off_set_meters           | double precision            | 0.0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |            |
| last_feature_end_off_set_meters              | double precision            | 0.0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |            |
| first_feature_forward                        | boolean                     | True                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |            |
| raw_data_types                               | integer                     | 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |            |
| external_data_origin                         | character varying(400)      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |            |
| external_data_destination                    | character varying(400)      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |            |
| external_data_waypoints                      | character varying(10000)    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |            |
| time_adjust_factor                           | double precision            | 1.0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |            |
| time_adjust_constant_seconds                 | double precision            | 0.0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |            |
| queue_max_speed_kmh                          | double precision            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |            |
| minimal_delay_speed_kmh                      | double precision            | 40.0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |            |
| major_delay_speed_kmh                        | double precision            | 30.0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |            |
| severe_delay_speed_kmh                       | double precision            | 15.0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |            |
| use_minimum_speed                            | boolean                     | False                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |            |
| length_m                                     | double precision            | 521.962145363725                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |            |
| start_timestamp                              | timestamp without time zone | 2025-02-26 19:14:07.989157                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |            |
| end_timestamp                                | timestamp without time zone |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |            |
| featurespeed_division_id                     | integer                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |            |
| severe_delay_issue_division_id               | smallint                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |            |
| major_delay_issue_division_id                | smallint                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |            |
| minor_delay_issue_division_id                | smallint                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |            |
| queue_issue_division_id                      | smallint                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |            |
| queue_detection_clearance_speed_kmh          | double precision            | 15.0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |            |
| severe_delay_clearance_speed_kmh             | double precision            | 15.0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |            |
| path_type                                    | smallint                    | 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |            |
| path_data_timeout_for_issue_creation_seconds | integer                     | 3600                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |            |
| encoded_polyline                             | character varying           | ahliGjhjcNuAhA??m@Rc@N??mBj@??aBl@??a@L_@LKFIFKHWRMJGDEBiBl@??qFdB                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |            |
| centreline_ids                               | bigint[]                    | [30003382, 30029397, 30029398, 30029395, 11070186, 8708642]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |            |
| geom                                         | geometry                    |  | geoms are calculating using centreline_latest from `centreline_ids` field when row is added to the database. May be incomplete. |


## `itsc_tt_raw` vs `itsc_tt_raw_pathdata`

These two tables appear to be largely identical.
- `itsc_tt_raw_pathdata` has 3 divisions, while `itsc_tt_raw` only has division_id = 2. 
- `itsc_tt_raw_pathdata` lacks the `raw_data_type` column that `itsc_tt_raw` has. However, a filter on that column doesn't appear to account for the row difference between the two tables.  

| "source_table"         | "division_id" | "count"  | "min_dt"              | "max_dt"              | "min_path_id" | "max_path_id" |
|------------------------|---------------|----------|-----------------------|-----------------------|---------------|---------------|
| "itsc_tt_raw"          | 2             | 3990988  | "2024-12-01 00:00:00" | "2025-04-06 23:59:00" | 5044778       | 10805348      |
| "itsc_tt_raw_pathdata" | 2             | 3612899  | "2024-12-01 00:00:00" | "2025-04-06 23:59:00" | 5044778       | 10805348      |
| "itsc_tt_raw_pathdata" | 8026          | 23393453 | "2024-12-01 00:00:00" | "2025-04-06 23:59:00" | 4884802       | 10818478      |
| "itsc_tt_raw_pathdata" | 8046          | 2558992  | "2024-12-01 00:00:00" | "2025-04-06 23:45:00" | 6733042       | 10699900      |

```sql
SELECT 'itsc_tt_raw_pathdata' AS source_table, division_id, COUNT(*), MIN(dt) AS min_dt, MAX(dt) AS max_dt, MIN(path_id) AS MIN_path_id, MAX(path_id) AS MAX_path_id
FROM bluetooth.itsc_tt_raw_pathdata GROUP BY 1,2
UNION
SELECT 'itsc_tt_raw', division_id, COUNT(*), MIN(dt), MAX(dt), MIN(path_id), MAX(path_id)
FROM bluetooth.itsc_tt_raw GROUP BY 1,2 ORDER BY 1, 2
```

### `bluetooth.itsc_tt_raw` (partitioned table)

Table contains travel time data for `division_id = 2`. 

Approx row count:            3,935,100
| Column Name                | Data Type                   | Sample              | Comments   |
|----------------------------|-----------------------------|---------------------|------------|
| division_id                | smallint                    | 2                   |            |
| path_id                    | integer                     | 5044782             |            |
| raw_data_type              | integer                     | 8                   |            |
| dt                         | timestamp without time zone | 2024-12-01 00:00:00 |            |
| travel_time_s              | integer                     | 791                 |            |
| quality_metric             | double precision            | 95.4274499005378    |            |
| num_samples                | integer                     | 337                 |            |
| congestion_start_meters    | double precision            |                     |            |
| congestion_end_meters      | double precision            |                     |            |
| min_speed_kmh              | double precision            |                     |            |
| fifth_percentile_tt_s      | integer                     | 517                 |            |
| nintyfifth_percentile_tt_s | integer                     | 1247                |            |
| unmatched                  | integer                     | 7124                |            |

### `bluetooth.itsc_tt_raw_pathdata` (partitioned table)

Table contains travel time data for `division_id IN (2, 8026, 8046)`. 

Approx row count:           29,858,600
| Column Name                 | Data Type                   | Sample              | Comments   |
|-----------------------------|-----------------------------|---------------------|------------|
| division_id                 | smallint                    | 8046                |            |
| path_id                     | integer                     | 7261884             |            |
| dt                          | timestamp without time zone | 2024-12-01 01:45:00 |            |
| travel_time_s               | integer                     | 50                  |            |
| quality_metric              | double precision            | 100.0               |            |
| num_samples                 | integer                     |                     |            |
| congestion_start_meters     | double precision            |                     |            |
| congestion_end_meters       | double precision            |                     |            |
| min_speed_kmh               | double precision            |                     |            |
| unmatched                   | integer                     |                     |            |
| fifth_percentile_tt_s       | integer                     |                     |            |
| ninty_fifth_percentile_tt_s | integer                     |                     |            |

# Analysis

More exploration is required...
[Here](./sql/select-weighted-percentiles.sql) is a toy example of a query to find percentile travel times weighted, each observation by `num_samples`. It could be run for either `itsc_tt_raw` or `itsc_tt_raw_pathdata`. 

# Data Ops

<!-- bluetooth_itsc_pull_doc_md -->
## `bluetooth_itsc_pull` DAG
- `create_annual_partition`: creates annual partitions on the first day of the year.
- `pull_raw_tt_data`: selects from ITSC `traveltimepathrawdata` and inserts into `bluetooth.itsc_tt_raw`.
- `pull_raw_tt_pathdata`: selects from ITSC `traveltimepathdata` and inserts into `bluetooth.itsc_tt_raw_pathdata`.
- `pull_tt_paths`: selects from ITSC `traveltimepathconfig` and inserts into `bluetooth.itsc_tt_paths`. Marked as skips if no new rows pulled. 
<!-- bluetooth_itsc_pull_doc_md -->

## Path Geoms
The `itsc_tt_path` geoms are created on insert using a [trigger](./sql/function-add_bluetooth_path_geom.sql), using the centreline_ids from ITSC `traveltimepathfeature`. They may become outdated as the centreline changes. 
