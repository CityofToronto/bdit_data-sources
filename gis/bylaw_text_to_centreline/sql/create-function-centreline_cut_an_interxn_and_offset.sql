DROP FUNCTION jchew._centreline_cut_an_interxn_and_offset(text, double precision, geometry, geometry, geometry);
CREATE OR REPLACE FUNCTION jchew._centreline_cut_an_interxn_and_offset
(direction_btwn2 text, metres_btwn2 FLOAT, centrelines geometry, new_line geometry, oid1_geom geometry,
OUT line_geom_cut GEOMETRY, OUT combined_section NUMRANGE)
--RETURNS GEOMETRY

LANGUAGE 'plpgsql'
AS $BODY$

DECLARE
--******** centrelines or whole_centreline
whole_centreline GEOMETRY := ST_LineMerge(ST_Union(centrelines));

BEGIN
line_geom_cut := (
-- case where the section of street from the intersection in the specified direction is shorter than x metres
CASE WHEN metres_btwn2 > ST_Length(ST_Transform(whole_centreline, 2952)) 
AND metres_btwn2 - ST_Length(ST_Transform(whole_centreline, 2952)) < 15
THEN whole_centreline

-- metres_btwn2/ST_Length(d.geom) is the fraction that is supposed to be cut off from the dissolved centreline segment(s)
-- cut off the first fraction of the dissolved line, and the second and check to see which one is closer to the original interseciton
-- aka to get the starting point of how the line is drawn and then cut accordingly

--when the from_intersection is at the end point of the original centreline
WHEN ST_LineLocatePoint(whole_centreline, oid1_geom)
> ST_LineLocatePoint(whole_centreline, ST_ClosestPoint(whole_centreline, ST_EndPoint(new_line)))
THEN ST_LineSubstring(whole_centreline, 
ST_LineLocatePoint(whole_centreline, oid1_geom) - (metres_btwn2/ST_Length(ST_Transform(whole_centreline, 2952))),
ST_LineLocatePoint(whole_centreline, oid1_geom) )

--when the from_intersection is at the start point of the original centreline 
WHEN ST_LineLocatePoint(whole_centreline, oid1_geom)
< ST_LineLocatePoint(whole_centreline, ST_ClosestPoint(whole_centreline, ST_EndPoint(new_line)))
-- take the substring from the intersection to the point x metres ahead of it
THEN ST_LineSubstring(whole_centreline, 
ST_LineLocatePoint(whole_centreline, oid1_geom),
ST_LineLocatePoint(whole_centreline, oid1_geom) + (metres_btwn2/ST_Length(ST_Transform(whole_centreline, 2952)))  )

END
);

combined_section := (
-- case where the section of street from the intersection in the specified direction is shorter than x metres
--take the whole centreline, range is [0,1]
CASE WHEN metres_btwn2 > ST_Length(ST_Transform(whole_centreline, 2952)) 
AND metres_btwn2 - ST_Length(ST_Transform(whole_centreline, 2952)) < 15
THEN numrange(0, 1, '[]')

--when the from_intersection is at the end point of the original centreline
--range is [xxx, 1]
WHEN ST_LineLocatePoint(whole_centreline, oid1_geom)
> ST_LineLocatePoint(whole_centreline, ST_ClosestPoint(whole_centreline, ST_EndPoint(new_line)))
THEN numrange ((ST_LineLocatePoint(whole_centreline, oid1_geom) - (metres_btwn2/ST_Length(ST_Transform(whole_centreline, 2952))))::numeric , 1::numeric, '[]')

--when the from_intersection is at the start point of the original centreline 
--range is [0, xxx]
WHEN ST_LineLocatePoint(whole_centreline, oid1_geom)
< ST_LineLocatePoint(whole_centreline, ST_ClosestPoint(whole_centreline, ST_EndPoint(new_line)))
-- take the substring from the intersection to the point x metres ahead of it
THEN numrange(0::numeric, (ST_LineLocatePoint(whole_centreline, oid1_geom) + (metres_btwn2/ST_Length(ST_Transform(whole_centreline, 2952))))::numeric, '[]')

END
);


RAISE NOTICE 'direction_btwn2: %, metres_btwn2: %  whole_centreline: %  new_line: %  oid1_geom: % line_geom_cut: %',
direction_btwn2, metres_btwn2, ST_ASText(whole_centreline), ST_ASText(new_line), ST_ASText(oid1_geom), ST_ASText(line_geom_cut);


END;
$BODY$;


COMMENT ON FUNCTION jchew._centreline_cut_an_interxn_and_offset(text, FLOAT, geometry,geometry, geometry) IS '
Meant to split line geometries of bylaw in effect locations where the bylaw occurs between an intersection and an offset.
Check out README in https://github.com/CityofToronto/bdit_data-sources/tree/master/gis/bylaw_text_to_centreline for more information';


****** TESTING
SELECT jchew._centreline_cut_an_interxn_and_offset('west', 330.33,
'0105000020E61000000100000001020000001300000023187EA570D453C0AC0EA47EE3D9454028B2397B65D453C03F1BE4EEE6D9454080BF3ABC57D453C06D5C7B76EBD94540F91D5D8155D453C04CAC4A2AECD94540DB10162754D453C087B78030EDD94540E8E73C1952D453C0863736FEEED9454018DFF94050D453C0F9E67B69F1D9454024F0F43B4ED453C0432B629EF6D94540424F0AC04DD453C0F2D40C71F8D94540220A17064DD453C021692B87FAD9454018C802124CD453C0FF4231A7FBD94540AAEDAA304BD453C0E47A505AFCD945406E523EF549D453C09657CA0CFDD94540B490A69848D453C037CEEA40FDD945402F1AA92C47D453C087EB5D2BFDD94540B1F3B5B545D453C02EE617C0FCD94540F14A2FBD3FD453C0B15D4455F8D945404B2F344E38D453C0D482D560F3D945406CA8FA9035D453C008A0E61EF1D94540'::geometry, 
												   '0102000020E610000002000000F511CD4333D453C09E415F54F4D945406D5CFC5B73D453C03BD0A446D7D94540'::geometry, 
												   '0101000020E6100000F511CD4333D453C09E415F54F4D94540'::geometry)



SELECT ST_LineLocatePoint(ST_LineMerge('0105000020E61000000100000001020000001300000023187EA570D453C0AC0EA47EE3D9454028B2397B65D453C03F1BE4EEE6D9454080BF3ABC57D453C06D5C7B76EBD94540F91D5D8155D453C04CAC4A2AECD94540DB10162754D453C087B78030EDD94540E8E73C1952D453C0863736FEEED9454018DFF94050D453C0F9E67B69F1D9454024F0F43B4ED453C0432B629EF6D94540424F0AC04DD453C0F2D40C71F8D94540220A17064DD453C021692B87FAD9454018C802124CD453C0FF4231A7FBD94540AAEDAA304BD453C0E47A505AFCD945406E523EF549D453C09657CA0CFDD94540B490A69848D453C037CEEA40FDD945402F1AA92C47D453C087EB5D2BFDD94540B1F3B5B545D453C02EE617C0FCD94540F14A2FBD3FD453C0B15D4455F8D945404B2F344E38D453C0D482D560F3D945406CA8FA9035D453C008A0E61EF1D94540'),
						 '0101000020E6100000F511CD4333D453C09E415F54F4D94540'::geometry)

SELECT ST_LineLocatePoint( ST_LineMerge('0105000020E61000000100000001020000001300000023187EA570D453C0AC0EA47EE3D9454028B2397B65D453C03F1BE4EEE6D9454080BF3ABC57D453C06D5C7B76EBD94540F91D5D8155D453C04CAC4A2AECD94540DB10162754D453C087B78030EDD94540E8E73C1952D453C0863736FEEED9454018DFF94050D453C0F9E67B69F1D9454024F0F43B4ED453C0432B629EF6D94540424F0AC04DD453C0F2D40C71F8D94540220A17064DD453C021692B87FAD9454018C802124CD453C0FF4231A7FBD94540AAEDAA304BD453C0E47A505AFCD945406E523EF549D453C09657CA0CFDD94540B490A69848D453C037CEEA40FDD945402F1AA92C47D453C087EB5D2BFDD94540B1F3B5B545D453C02EE617C0FCD94540F14A2FBD3FD453C0B15D4455F8D945404B2F344E38D453C0D482D560F3D945406CA8FA9035D453C008A0E61EF1D94540'::geometry),
ST_ClosestPoint('0105000020E61000000100000001020000001300000023187EA570D453C0AC0EA47EE3D9454028B2397B65D453C03F1BE4EEE6D9454080BF3ABC57D453C06D5C7B76EBD94540F91D5D8155D453C04CAC4A2AECD94540DB10162754D453C087B78030EDD94540E8E73C1952D453C0863736FEEED9454018DFF94050D453C0F9E67B69F1D9454024F0F43B4ED453C0432B629EF6D94540424F0AC04DD453C0F2D40C71F8D94540220A17064DD453C021692B87FAD9454018C802124CD453C0FF4231A7FBD94540AAEDAA304BD453C0E47A505AFCD945406E523EF549D453C09657CA0CFDD94540B490A69848D453C037CEEA40FDD945402F1AA92C47D453C087EB5D2BFDD94540B1F3B5B545D453C02EE617C0FCD94540F14A2FBD3FD453C0B15D4455F8D945404B2F344E38D453C0D482D560F3D945406CA8FA9035D453C008A0E61EF1D94540'::geometry ,
ST_LineSubstring('0102000020E610000002000000F511CD4333D453C09E415F54F4D945406D5CFC5B73D453C03BD0A446D7D94540'::GEOMETRY, 0.99999, 1) ) )

SELECT ST_LineSubstring(ST_LineMerge('0105000020E61000000100000001020000001300000023187EA570D453C0AC0EA47EE3D9454028B2397B65D453C03F1BE4EEE6D9454080BF3ABC57D453C06D5C7B76EBD94540F91D5D8155D453C04CAC4A2AECD94540DB10162754D453C087B78030EDD94540E8E73C1952D453C0863736FEEED9454018DFF94050D453C0F9E67B69F1D9454024F0F43B4ED453C0432B629EF6D94540424F0AC04DD453C0F2D40C71F8D94540220A17064DD453C021692B87FAD9454018C802124CD453C0FF4231A7FBD94540AAEDAA304BD453C0E47A505AFCD945406E523EF549D453C09657CA0CFDD94540B490A69848D453C037CEEA40FDD945402F1AA92C47D453C087EB5D2BFDD94540B1F3B5B545D453C02EE617C0FCD94540F14A2FBD3FD453C0B15D4455F8D945404B2F344E38D453C0D482D560F3D945406CA8FA9035D453C008A0E61EF1D94540'::geometry),

ST_LineLocatePoint(ST_LineMerge('0105000020E61000000100000001020000001300000023187EA570D453C0AC0EA47EE3D9454028B2397B65D453C03F1BE4EEE6D9454080BF3ABC57D453C06D5C7B76EBD94540F91D5D8155D453C04CAC4A2AECD94540DB10162754D453C087B78030EDD94540E8E73C1952D453C0863736FEEED9454018DFF94050D453C0F9E67B69F1D9454024F0F43B4ED453C0432B629EF6D94540424F0AC04DD453C0F2D40C71F8D94540220A17064DD453C021692B87FAD9454018C802124CD453C0FF4231A7FBD94540AAEDAA304BD453C0E47A505AFCD945406E523EF549D453C09657CA0CFDD94540B490A69848D453C037CEEA40FDD945402F1AA92C47D453C087EB5D2BFDD94540B1F3B5B545D453C02EE617C0FCD94540F14A2FBD3FD453C0B15D4455F8D945404B2F344E38D453C0D482D560F3D945406CA8FA9035D453C008A0E61EF1D94540'::geometry),
						 '0101000020E6100000F511CD4333D453C09E415F54F4D94540'::GEOMETRY) - (330.33/ST_Length(ST_Transform(ST_LineMerge('0105000020E61000000100000001020000001300000023187EA570D453C0AC0EA47EE3D9454028B2397B65D453C03F1BE4EEE6D9454080BF3ABC57D453C06D5C7B76EBD94540F91D5D8155D453C04CAC4A2AECD94540DB10162754D453C087B78030EDD94540E8E73C1952D453C0863736FEEED9454018DFF94050D453C0F9E67B69F1D9454024F0F43B4ED453C0432B629EF6D94540424F0AC04DD453C0F2D40C71F8D94540220A17064DD453C021692B87FAD9454018C802124CD453C0FF4231A7FBD94540AAEDAA304BD453C0E47A505AFCD945406E523EF549D453C09657CA0CFDD94540B490A69848D453C037CEEA40FDD945402F1AA92C47D453C087EB5D2BFDD94540B1F3B5B545D453C02EE617C0FCD94540F14A2FBD3FD453C0B15D4455F8D945404B2F344E38D453C0D482D560F3D945406CA8FA9035D453C008A0E61EF1D94540'::geometry), 2952)))
,
 ST_LineLocatePoint(ST_LineMerge('0105000020E61000000100000001020000001300000023187EA570D453C0AC0EA47EE3D9454028B2397B65D453C03F1BE4EEE6D9454080BF3ABC57D453C06D5C7B76EBD94540F91D5D8155D453C04CAC4A2AECD94540DB10162754D453C087B78030EDD94540E8E73C1952D453C0863736FEEED9454018DFF94050D453C0F9E67B69F1D9454024F0F43B4ED453C0432B629EF6D94540424F0AC04DD453C0F2D40C71F8D94540220A17064DD453C021692B87FAD9454018C802124CD453C0FF4231A7FBD94540AAEDAA304BD453C0E47A505AFCD945406E523EF549D453C09657CA0CFDD94540B490A69848D453C037CEEA40FDD945402F1AA92C47D453C087EB5D2BFDD94540B1F3B5B545D453C02EE617C0FCD94540F14A2FBD3FD453C0B15D4455F8D945404B2F344E38D453C0D482D560F3D945406CA8FA9035D453C008A0E61EF1D94540'::geometry),
						 '0101000020E6100000F511CD4333D453C09E415F54F4D94540'::GEOMETRY) )
